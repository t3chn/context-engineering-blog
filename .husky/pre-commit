#!/bin/sh

# Run lint-staged (ESLint + Prettier on staged files)
echo "üîß Running lint-staged..."
pnpm lint-staged || exit 1

# Prevent committing secrets
# Check for common secret patterns in staged files

echo "üîç Checking for secrets..."

# Patterns to detect
PATTERNS=(
  'ANTHROPIC_API_KEY\s*=\s*["\x27]?sk-ant-'
  'OPENAI_API_KEY\s*=\s*["\x27]?sk-'
  'GEMINI_API_KEY\s*=\s*["\x27]?AIza'
  'TELEGRAM_BOT_TOKEN\s*=\s*["\x27]?[0-9]+:[A-Za-z0-9_-]+'
  'AWS_SECRET_ACCESS_KEY\s*=\s*["\x27]?[A-Za-z0-9/+=]{40}'
  'GITHUB_TOKEN\s*=\s*["\x27]?ghp_'
  'password\s*=\s*["\x27][^"]+["\x27]'
)

# Get staged files (excluding deleted ones)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

# Check each pattern
FOUND_SECRETS=0
for pattern in "${PATTERNS[@]}"; do
  MATCHES=$(echo "$STAGED_FILES" | xargs grep -lE "$pattern" 2>/dev/null | grep -v ".env.example")
  if [ -n "$MATCHES" ]; then
    echo "‚ùå Potential secret found matching pattern: $pattern"
    echo "   In files: $MATCHES"
    FOUND_SECRETS=1
  fi
done

# Also check for .env files being committed
ENV_FILES=$(echo "$STAGED_FILES" | grep -E '^\.env$|^\.env\.local$|^\.env\.[^.]+\.local$')
if [ -n "$ENV_FILES" ]; then
  echo "‚ùå Attempting to commit .env file: $ENV_FILES"
  FOUND_SECRETS=1
fi

if [ $FOUND_SECRETS -eq 1 ]; then
  echo ""
  echo "üõë Commit blocked! Remove secrets before committing."
  echo "   If this is a false positive, use: git commit --no-verify"
  exit 1
fi

echo "‚úì No secrets detected"
exit 0
